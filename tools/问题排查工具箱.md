# 问题排查工具箱



## jvm相关

### jstack/pstack

**`jstack 18207|grep'0X47A'-C5 --color`**

### jstat 查询jvm当前的状态，常用查看gc状况

jstat -gcutil pid 1000

Jstat -gc pid 1000

### jmap 常用语jvm内存分析（dump文件）

jmap -dump:format=b,file=/logs/4273-pid.map 4273

上述dump文件可以使用MAT分析工具进行分析，从而找出jvm内存相关的潜在问题（后面会专门详细介绍MAT的使用）



## 网络相关

#### tcpdump

主要是掌握如何书写表达式来进行过滤从而找到自己需要的报文，如果不过滤，会抓取网络上所有报文，信息量巨大无法排查。

1. 表达式书写

   - 类型关键字：host ,net ,port

   - 传输方向关键字：src, dst ,dst or src,dst and src

   - 协议关键字：fddi，ip，arp，rarp，tcp，udp

   - 逻辑运算

     ```
     非运算 not !
     与运算 and &&
     或运算 or ||
     ```

   - 其他关键字：gateway， broadcast，less，greeter

2. 输出结果

   - 数据链路层头信息：tcpdump -e host usam
   - arp包输出：tcpdum arp
   - tcp包输出信息：tcpdum tcp

   ```
   src > dst: flags data-seqno ack window urgent options
   src > dst:表明从源地址到目的地址， flags是TCP报文中的标志信息，S 是SYN标志， F (FIN)， P (PUSH) ， R (RST) "." (没有标记); 
   data-seqno是报文中的数据的顺序号， ack是下次期望的顺序号同时是对上一个序号的确认， window是接收缓存的窗口大小， 
   urgent表明报文中是否有紧急指针。 
   Options是选项
   
   捕获tcp协议报文例子：
   tcpdump -vv tcp and dst 172.19.71.188
   09:56:31.090876 IP (tos 0x0, ttl 63, id 0, offset 0, flags [DF], proto TCP (6), length 52)
       172.31.15.5.63204 > dc-rpasource-dev.ssh: Flags [.], cksum 0xf625 (correct), seq 0, ack 73761, win 2043, options [nop,nop,TS val 568451363 ecr 2673811049], length 0
   
   ```

   - -w选项保存监听数据包到指定文件：tcpdump -w tcp.txt tcp and port 50050
   - -c指定监听的数据包数，未指定则持续监听：tcpdump -w tcp.txt -c 100 tcp and port 50050
   - -nn 抓取结果直接主机id及端口号显示 不以主机名和和服务名称显示：tcpdump -nn -w tcp.txt -c 100 tcp and port 50050
   - -X 可以列出16进制和ASCII的数据包内容
   
   

TCP/IP协议4层模型

1. 数据链路层

2. 网络层

3. 传输层

   1. tcp协议报文头：最小20B

   ```
   [源端口2B][目的端口2B]
   [序号4B]
   [确认序号ack4B]
   [首部长度4b][保留长度6b][标志位6b][窗口大小2B]
   [首部校验和2B][紧急指针2B]
   [..可选部分]
   [可选数据部分]
   ```

   2. 6种标志位
      - SYN
      - FIN
      - RST
      - PSH
      - UGT
      - ACK

4. 应用层



## 系统相关

#### top

是linux系统中常用的性能分析工具，实时显示系统中各个进程的资源占用情况，类似windows任务管理器

- 可以按CPU使用.内存使用和执行时间对任务进行排序

- 支持交互式命令

  - f : 可以选择添加或删除要显示的字段以及字段的排序位置

    ```
    上下键 ：移动选择字段
    空格 ：添加或取消显示某个字段
    右箭头-> : 选择当前字段移动其上下位置
    ```

    

分文以下几个显示部分

##### 系统整体情况

```
top - 10:26:11 up 4 days, 18:14,  1 user,  load average: 0.25, 0.09, 0.12
01:06:48    当前时间
up 1:22    系统运行时间，格式为时:分
1 user    当前登录用户数
load average: 0.06, 0.60, 0.48    系统负载，即任务队列的平均长度。三个数值分别为 1分钟、5分钟、15分钟前到现在的平均值。
```

##### 进程整体信息

```
Tasks:  29 total,   1 running,  28 sleeping,   0 stopped,   0 zombie

total 进程总数
running 正在运行的进程数
sleeping 睡眠的进程数
stopped 停止的进程数
zombie 僵尸进程数
```

##### cpu信息

```
Cpu(s):  0.3% us,  1.0% sy,  0.0% ni, 98.7% id,  0.0% wa,  0.0% hi,  0.0% si
0.3% us 用户空间占用CPU百分比
1.0% sy 内核空间占用CPU百分比
0.0% ni 用户进程空间内改变过优先级的进程占用CPU百分比
98.7% id 空闲CPU百分比
0.0% wa 等待输入输出的CPU时间百分比
0.0%hi：硬件CPU中断占用百分比
0.0%si：软中断占用百分比
0.0%st：虚拟机占用百分比
```

##### 内存信息

```
KiB Mem :  1798908 total,    84964 free,   922244 used,   791700 buff/cache
KiB Swap:        0 total,        0 free,        0 used.   704784 avail Mem

191272k total    物理内存总量
17616k free    空闲内存总量
173656k used    使用的物理内存总量
22052k buff/cache    用作内核缓存的内存量
Swap: 
192772k total    交换区总量
0k free    空闲交换区总量
0k used    使用的交换区总量
avail Mem 交换去可用内存
```

##### 各个进程详细信息

```
PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND                                                                                                                                    
20485 root      20   0 2994536 767308  11724 S  4.3 42.7 110:13.26 java 

序号  列名    含义
a    PID     进程id
b    nTH     当前进程包含的线程数
e    USER    进程所有者的用户名
h    PR      优先级，用户不能直接修改，是由内核动态调整的，nice值可以影响PR值
i    NI      nice值(-20~19)。友好值值对其他进程约友好。负值表示高优先级，正值表示低优先级
o    VIRT    进程使用的虚拟内存总量，单位kb。VIRT=SWAP+RES
q    RES     进程使用的、未被换出的物理内存大小，单位kb。RES=CODE+DATA
t    SHR     共享内存大小，单位kb
w    S       进程状态(D=不可中断的睡眠状态,R=运行,S=睡眠,T=跟踪/停止,Z=僵尸进程)
k    %CPU    上次更新到现在的CPU时间占用百分比
n    %MEM    进程使用的物理内存百分比
m    TIME+   进程使用的CPU时间总计，单位1/100秒
x    COMMAND 命令名/命令行
```



### ps





### 其他超有用命令

#### awk强大的文本分析工具

对于文件或文本基于指定规则浏览和抽取信息，awk是三位作者的名字简写，拥有自己的编程语言，具有非常强大抽取指定文件或文本中内容，并按照自定义格式进行统计输出的能力。

##### 基础用法

awk pattern + action ：对于每一个匹配的结果都会执行指定的action动作。

##### 内置变量

```
ARGC               命令行参数个数
ARGV               命令行参数排列
ENVIRON            支持队列中系统环境变量的使用
FILENAME           awk浏览的文件名
FNR                浏览文件的记录数
FS                 设置输入域分隔符，等价于命令行 -F选项
NF                 浏览记录的域的个数
NR                 已读的记录数
OFS                输出域分隔符
ORS                输出记录分隔符
RS                 控制记录分隔符
$0                 指的是整个记录
$1                 指的是第一个匹配域（默认是以空格或tab进行分割，可以自定义）
```

##### 选项

-F 指定域分割方式

























### 引用top命令详细

```

详细选项设定：

d 指定每两次屏幕信息刷新之间的时间间隔。当然用户可以使用s交互命令来改变之。 
p 通过指定监控进程ID来仅仅监控某个进程的状态。 
q 该选项将使top没有任何延迟的进行刷新。如果调用程序有超级用户权限，那么top将以尽可能高的优先级运行。 
S 指定累计模式 
s 使top命令在安全模式中运行。这将去除交互命令所带来的潜在危险。 
i 使top不显示任何闲置或者僵死进程。 
c 显示整个命令行而不只是显示命令名 

详细交互命令设定：

Ctrl+L 擦除并且重写屏幕。 
h或者? 显示帮助画面，给出一些简短的命令总结说明。 
k       终止一个进程。系统将提示用户输入需要终止的进程PID，以及需要发送给该进程什么样的信号。一般的终止进程可以使用15信号；如果不能正常结束那就使用信号9强制结束该进程。默认值是信号15。在安全模式中此命令被屏蔽。 
i 忽略闲置和僵死进程。这是一个开关式命令。 
q 退出程序。 
r 重新安排一个进程的优先级别。系统提示用户输入需要改变的进程PID以及需要设置的进程优先级值。输入一个正值将使优先级降低，反之则可以使该进程拥有更高的优先权。默认值是10。 
S 切换到累计模式。 
s 改变两次刷新之间的延迟时间。系统将提示用户输入新的时间，单位为s。如果有小数，就换算成m s。输入0值则系统将不断刷新，默认值是5 s。需要注意的是如果设置太小的时间，很可能会引起不断刷新，从而根本来不及看清显示的情况，而且系统负载也会大大增加。 
f或者F 从当前显示中添加或者删除项目。 
o或者O 改变显示项目的顺序。 
l 切换显示平均负载和启动时间信息。 
m 切换显示内存信息。 
t 切换显示进程和CPU状态信息。 
c 切换显示命令名称和完整命令行。 
M 根据驻留内存大小进行排序。 
P 根据CPU使用百分比大小进行排序。 
T 根据时间/累计时间进行排序。 
W 将当前设置写入~/.toprc文件中。这是写top配置文件的推荐方法。
```



### 引用tcpdump详细选项：

```
-A 以ASCII格式打印出所有分组，并将链路层的头最小化。（通常用来抓取www网页的数据） 
-c 在收到指定的数量的分组后，tcpdump就会停止。 
-C 在将一个原始分组写入文件之前，检查文件当前的大小是否超过了参数file_size 中指定的大小。如果超过了指定大小，则关闭当前文件，然后在打开一个新的文件。参数 file_size 的单位是兆字节（是1,000,000字节，而不是1,048,576字节）。 
-d 将匹配信息包的代码以人们能够理解的汇编格式给出。 
-dd 将匹配信息包的代码以c语言程序段的格式给出。 
-ddd 将匹配信息包的代码以十进制的形式给出。 
-D 打印出系统中所有可以用tcpdump截包的网络接口。 
-e 在输出行打印出数据链路层的头部信息。 
-E 用spi@ipaddr algo:secret解密那些以addr作为地址，并且包含了安全参数索引值spi的IPsec ESP分组。 
-f 将外部的Internet地址以数字的形式打印出来。 
-F 从指定的文件中读取表达式，忽略命令行中给出的表达式。 
-i 指定监听的网络接口。 
-l 使标准输出变为缓冲行形式，可以把数据导出到文件。 
-L 列出网络接口的已知数据链路。 
-m 从文件module中导入SMI MIB模块定义。该参数可以被使用多次，以导入多个MIB模块。 
-M 如果tcp报文中存在TCP-MD5选项，则需要用secret作为共享的验证码用于验证TCP-MD5选选项摘要（详情可参考RFC 2385）。 
-b 在数据-链路层上选择协议，包括ip、arp、rarp、ipx都是这一层的。
-n 不把网络地址转换成名字。
-nn 不进行端口名称的转换。
-N 不输出主机名中的域名部分。例如，‘nic.ddn.mil‘只输出’nic‘。 
-t 在输出的每一行不打印时间戳。 
-O 不运行分组分组匹配（packet-matching）代码优化程序。 
-P 不将网络接口设置成混杂模式。 
-q 快速输出。只输出较少的协议信息。 
-X，可以列出十六进制 (hex) 以及 ASCII 的数据包内容，对于监听数据包内容很有用。
-r 从指定的文件中读取包(这些包一般通过-w选项产生)。 
-S 将tcp的序列号以绝对值形式输出，而不是相对值。 
-s 从每个分组中读取最开始的snaplen个字节，而不是默认的68个字节。 
-T 将监听到的包直接解释为指定的类型的报文，常见的类型有rpc远程过程调用）和snmp（简单网络管理协议；）。 
-t 不在每一行中输出时间戳。 
-tt 在每一行中输出非格式化的时间戳。 
-ttt 输出本行和前面一行之间的时间差。 
-tttt 在每一行中输出由date处理的默认格式的时间戳。 
-u 输出未解码的NFS句柄。 
-v 输出一个稍微详细的信息，例如在ip包中可以包括ttl和服务类型的信息。 
-vv 输出详细的报文信息。 
-w 直接将分组写入文件中，而不是不分析并打印出来。

```



### 引用OSI7层网络模型：

1. 物理层
2. 数据链路层
3. 网络层
4. 传输层
5. 会话层
6. 表示层
7. 应用层



参考文章：

1. https://www.lijiaocn.com/tags/toolsbox.html

